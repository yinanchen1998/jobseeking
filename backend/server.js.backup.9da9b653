import express from 'express';
import cors from 'cors';
import fetch from 'node-fetch';
import dotenv from 'dotenv';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

dotenv.config();

const KIMI_API_KEY = process.env.KIMI_API_KEY || '';
const KIMI_API_URL = 'https://api.moonshot.cn/v1/chat/completions';

const app = express();
app.use(cors());
app.use(express.json());

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ========== Bing æœç´¢ ==========
async function searchBing(query, limit = 5) {
  try {
    console.log(`[Bing] æœç´¢: "${query}"`);
    const url = `https://cn.bing.com/search?q=${encodeURIComponent(query)}&count=${limit}`;
    
    const response = await fetch(url, {
      headers: { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36' }
    });
    
    const html = await response.text();
    const results = [];
    let start = 0;
    
    for (let i = 0; i < limit; i++) {
      const li = html.indexOf('<li class="b_algo"', start);
      if (li === -1) break;
      const liEnd = html.indexOf('</li>', li);
      const block = html.substring(li, liEnd);
      
      const href = block.indexOf('href="');
      if (href === -1) continue;
      const hrefEnd = block.indexOf('"', href + 6);
      const link = block.substring(href + 6, hrefEnd);
      
      const tit = block.indexOf('>', hrefEnd);
      const titEnd = block.indexOf('</a>', tit);
      let title = block.substring(tit + 1, titEnd).replace(/<[^>]+>/g, '').trim();
      
      if (title && link) {
        results.push({
          title,
          link: link.startsWith('http') ? link : `https://cn.bing.com${link}`,
          snippet: '',
          source: link.includes('github.com') ? 'bing_github' : 'bing'
        });
      }
      start = liEnd;
    }
    
    console.log(`[Bing] æ‰¾åˆ° ${results.length} ä¸ªç»“æœ`);
    return results.length > 0 ? results : null;
  } catch (e) {
    console.error('[Bing] é”™è¯¯:', e.message);
    return null;
  }
}

// ========== æœç´¢ API ==========
app.post('/api/search', async (req, res) => {
  const { query } = req.body;
  if (!query?.trim()) return res.status(400).json({ error: 'æœç´¢è¯ä¸èƒ½ä¸ºç©º' });
  if (!KIMI_API_KEY) return res.status(500).json({ error: 'Kimi API Key æœªé…ç½®' });

  const responseTimeout = setTimeout(() => {
    if (!res.headersSent) res.status(504).json({ error: 'æœç´¢è¶…æ—¶' });
  }, 70000);

  try {
    const searchType = query.match(/[A-Z]/) && !query.match(/[\u4e00-\u9fa5]/) ? 'product' : 'need';
    console.log(`[Search] ç±»å‹: ${searchType}, æŸ¥è¯¢: "${query}"`);

    // Bing æœç´¢
    const bingPromise = searchBing(query, 5).catch(() => null);

    // Kimi æœç´¢
    const prompt = searchType === 'product'
      ? `æœç´¢äº§å“ï¼š"${query}"ï¼Œè¿”å›JSONï¼š[{name, chineseName, tagline, description, category, website, source}]`
      : `æœç´¢ï¼š"${query}"ï¼Œæ¨è3-5ä¸ªæ±‚èŒAIå·¥å…·ï¼Œè¿”å›JSONæ•°ç»„`;

    const kimiPromise = fetch(KIMI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${KIMI_API_KEY}` },
      body: JSON.stringify({ model: 'moonshot-v1-8k', messages: [{role: 'user', content: prompt}], temperature: 0.3 })
    }).then(r => r.json()).then(d => d.choices?.[0]?.message?.content || '').catch(() => '');

    const [bingResults, kimiContent] = await Promise.all([bingPromise, kimiPromise]);

    let kimiResults = [];
    if (kimiContent) {
      try { kimiResults = JSON.parse(kimiContent.replace(/```json\s*/g, '').replace(/```\s*$/g, '').trim()); } catch (e) {}
    }

    // åˆå¹¶
    let finalResults = [];
    if (bingResults?.length) {
      bingResults.forEach(g => finalResults.push({
        name: g.title?.substring(0, 50) || 'Unknown',
        chineseName: g.title?.substring(0, 50) || 'Unknown',
        tagline: '',
        description: '',
        category: 'other',
        website: g.link,
        source: 'bing'
      }));
    }

    kimiResults.forEach(k => {
      if (!finalResults.some(f => f.website === k.website)) finalResults.push(k);
    });

    clearTimeout(responseTimeout);
    res.json({
      query,
      searchType,
      bingCount: bingResults?.length || 0,
      kimiCount: kimiResults.length,
      results: finalResults.slice(0, 5),
      sources: { bing: !!bingResults?.length, kimi: !!kimiResults.length }
    });
  } catch (error) {
    clearTimeout(responseTimeout);
    res.status(500).json({ error: 'æœç´¢æœåŠ¡å‡ºé”™' });
  }
});

// ========== Research API ==========
const researchTasks = new Map();

app.post('/api/research', async (req, res) => {
  const { toolId, toolName } = req.body;
  if (!toolId || !toolName) return res.status(400).json({ error: 'ç¼ºå°‘å‚æ•°' });

  const taskId = Date.now().toString();
  
  setTimeout(async () => {
    try {
      const prompt = `ä¸º"${toolName}"ç”Ÿæˆäº§å“è°ƒç ”æŠ¥å‘Šï¼Œè¿”å›JSONï¼š{summary, details, pros[], cons[], pricing, rating}`;
      const response = await fetch(KIMI_API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${KIMI_API_KEY}` },
        body: JSON.stringify({ model: 'moonshot-v1-8k', messages: [{role: 'user', content: prompt}] })
      });
      const data = await response.json();
      const content = data.choices?.[0]?.message?.content || '';
      
      let report;
      try { report = JSON.parse(content.match(/\{[\s\S]*\}/)[0]); } catch(e) { report = {summary: toolName, details: content}; }
      
      researchTasks.set(taskId, { status: 'completed', toolId, toolName, report });
    } catch (error) {
      researchTasks.set(taskId, { status: 'failed', error: error.message });
    }
  }, 100);
  
  res.json({ taskId, status: 'pending' });
});

app.get('/api/research/:taskId', (req, res) => {
  const task = researchTasks.get(req.params.taskId);
  if (!task) return res.status(404).json({ error: 'ä»»åŠ¡ä¸å­˜åœ¨' });
  res.json(task);
});

app.delete('/api/research/:toolId', (req, res) => {
  for (const [taskId, task] of researchTasks.entries()) {
    if (task.toolId === req.params.toolId) researchTasks.delete(taskId);
  }
  res.json({ success: true });
});

// å¯åŠ¨
const PORT = process.env.PORT || 3001;
app.listen(PORT, () => console.log(`ğŸš€ åç«¯è¿è¡Œåœ¨ http://localhost:${PORT}`));
