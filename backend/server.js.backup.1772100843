import express from 'express';
import cors from 'cors';
import fetch from 'node-fetch';
import dotenv from 'dotenv';
import { exec } from 'child_process';
import { promisify } from 'util';

const execAsync = promisify(exec);
dotenv.config();

const KIMI_API_KEY = process.env.KIMI_API_KEY;
const KIMI_API_URL = 'https://api.moonshot.cn/v1/chat/completions';

// Google æœç´¢å‡½æ•°
async function searchGoogle(query, timeout = 35000) {
  try {
    const proxyUrl = process.env.HTTP_PROXY || process.env.HTTPS_PROXY;
    console.log(`[Google] å¼€å§‹æœç´¢: "${query}"`);
    
    const searchQuery = query.includes('æ±‚èŒ') ? query : `${query} job search AI`;
    const cliPath = '/root/jobseeking/lib/google-search/dist/src/index.js';
    const cmd = `node "${cliPath}" --limit 5 --timeout ${timeout} --state-file ./browser-state.json '-- "${searchQuery}"'`;
    
    const { stdout } = await execAsync(cmd, {
      cwd: '/root/jobseeking/backend',
      env: { ...process.env, HTTP_PROXY: proxyUrl, HTTPS_PROXY: proxyUrl },
      timeout: timeout + 5000
    });
    
    const results = JSON.parse(stdout);
    if (!results?.results?.length) return null;
    
    return results.results.map(r => ({
      title: r.title,
      link: r.link,
      snippet: r.snippet,
      source: r.link?.includes('github.com') ? 'google_github' : 'google'
    }));
  } catch (error) {
    console.error('[Google] é”™è¯¯:', error.message);
    return null;
  }
}

async function fetchWithTimeout(url, options = {}, timeout = 15000) {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), timeout);
  try {
    const response = await fetch(url, { ...options, signal: controller.signal });
    clearTimeout(timeoutId);
    return response;
  } catch (error) {
    clearTimeout(timeoutId);
    throw error;
  }
}

function detectSearchType(query) {
  const productPatterns = [/[A-Z][a-z]+[A-Z]/, /[a-z]+[A-Z][a-z]+/, /^(ChatGPT|OpenAI|Claude)/i];
  const needPatterns = [/(ç®€å†|æ±‚èŒ|é¢è¯•|å·¥ä½œ|æ‹›è˜)/, /(å¦‚ä½•|æ€ä¹ˆ|æ¨è)/];
  const isProduct = productPatterns.some(p => p.test(query));
  const isNeed = needPatterns.some(p => p.test(query));
  if (isProduct && !isNeed) return 'product';
  if (isNeed && !isProduct) return 'need';
  return query.length < 20 ? 'product' : 'need';
}

const app = express();
app.use(cors());
app.use(express.json());

app.post('/api/search', async (req, res) => {
  const { query } = req.body;
  if (!query?.trim()) return res.status(400).json({ error: 'æœç´¢è¯ä¸èƒ½ä¸ºç©º' });
  if (!KIMI_API_KEY) return res.status(500).json({ error: 'Kimi API Key æœªé…ç½®' });

  const responseTimeout = setTimeout(() => {
    if (!res.headersSent) res.status(504).json({ error: 'æœç´¢è¶…æ—¶' });
  }, 70000);

  try {
    const searchType = detectSearchType(query);
    console.log(`[Search] ç±»å‹: ${searchType}, æŸ¥è¯¢: "${query}"`);

    const googlePromise = searchGoogle(query + ' æ±‚èŒå·¥å…·', 35000).catch(() => null);
    
    const prompt = searchType === 'product' 
      ? `æœç´¢äº§å“ï¼š"${query}"ï¼Œè¿”å›JSONæ•°ç»„ï¼š[{name, chineseName, tagline, description, category, website, source}]`
      : `æœç´¢ï¼š"${query}"ï¼Œæ¨è3-5ä¸ªæ±‚èŒAIå·¥å…·ï¼Œè¿”å›JSONæ•°ç»„ï¼š[{name, chineseName, tagline, description, category, website, source}]`;

    const kimiPromise = fetchWithTimeout(KIMI_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${KIMI_API_KEY}` },
      body: JSON.stringify({ model: 'moonshot-v1-8k', messages: [{ role: 'system', content: 'ä½ æ˜¯æ±‚èŒå·¥å…·æœç´¢ä¸“å®¶ã€‚åªè¿”å›JSONæ•°ç»„ã€‚' }, { role: 'user', content: prompt }], temperature: 0.3 })
    }, 25000).then(r => r.ok ? r.json() : null).then(d => d?.choices?.[0]?.message?.content || '').catch(() => '');

    const [googleResults, kimiContent] = await Promise.all([googlePromise, kimiPromise]);
    console.log(`[Search] Google: ${googleResults?.length || 0}ä¸ª, Kimi: ${kimiContent ? 'æœ‰' : 'æ— '}`);

    let kimiResults = [];
    if (kimiContent) {
      try { kimiResults = JSON.parse(kimiContent.replace(/```json\s*/g, '').replace(/```\s*$/g, '').trim()); } catch (e) {}
    }

    let finalResults = [];
    if (googleResults?.length) {
      googleResults.forEach(g => finalResults.push({ name: g.title?.split(' - ')[0] || 'Unknown', chineseName: g.title?.split(' - ')[0] || 'Unknown', tagline: g.snippet?.substring(0, 50) + '...', description: g.snippet, category: 'other', website: g.link, source: g.source, linkStatus: { valid: false, checked: false } }));
    }
    kimiResults.forEach(k => { if (!finalResults.some(f => f.website === k.website)) finalResults.push({ ...k, linkStatus: { valid: false, checked: false } }); });

    clearTimeout(responseTimeout);
    res.json({ query, searchType, googleCount: googleResults?.length || 0, kimiCount: kimiResults.length, results: finalResults.slice(0, 5), sources: { google: !!googleResults?.length, kimi: !!kimiResults.length } });
  } catch (error) {
    clearTimeout(responseTimeout);
    res.status(500).json({ error: 'æœç´¢æœåŠ¡å‡ºé”™', message: error.message });
  }
});

app.listen(3001, () => console.log('ğŸš€ åç«¯è¿è¡Œåœ¨ http://localhost:3001'));
